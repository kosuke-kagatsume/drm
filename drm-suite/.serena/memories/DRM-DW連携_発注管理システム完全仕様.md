# DRM-DW連携：発注管理システム 完全仕様書

**作成日**: 2025-10-08  
**目的**: 見積→契約→発注→工事進捗→請求の完全連動システム（DRMとDWのAPI連携）

---

## 🎯 全体フロー図

```
【DRM】見積作成・承認
   ↓
【DRM】契約締結
   ↓
【DRM】発注先決定（契約後7日以内）★核心機能★
   ├─ 仮設工事 → A工業（過去実績5件、評価4.5）
   ├─ 基礎工事 → B建設（過去実績3件、評価4.2）
   ├─ 造作工事 → C工務店
   └─ ... 全原価項目に協力会社を割当
   ↓
【API】DRM → DW (REST API: 発注データ送信)
   フォーマット: CSV形式準拠のJSON
   ステータス: 1(見積) → 2(発注)
   ↓
【DW】発注実行・現場管理・進捗管理
   ステータス遷移:
   - 2(発注) → 4(工事完了) → 5(工事確認) → 6(請求)
   - 追加工事管理（DW内で承認完結）
   - 諸口管理
   ↓
【API】DW → DRM (毎日、実績原価データ取得)
   ↓
【DRM】工事台帳に確定原価反映
   ↓
【DRM】粗利予測をリアルタイム計算・表示
   予定原価 vs 確定原価の差分 ← 超重要KPI！
```

---

## 📋 DRMとDWの役割分担

### **DRM側の役割**

1. **見積作成・承認**
   - 見積エディタ（editor-v3）で原価積算
   - 原価には協力会社への外注費を含む
   - 複数見積提出→1つに決定

2. **契約管理**
   - 見積から契約書への自動変換
   - 契約承認フロー
   - 追加契約の管理

3. **発注先決定（★新機能の核心★）**
   - 契約後7日以内に全原価の発注先を決定
   - 各工事項目に協力会社を割当
   - 協力会社選定基準：価格・実績・評価・空き状況
   - 承認フロー（会社ごとに設定可能）
   - 期限アラート・上司通知

4. **工事台帳（確定原価の記録）**
   - DWから取得した実績原価を記録
   - 予定原価 vs 確定原価の差分管理
   - 粗利予測のリアルタイム計算

5. **原価管理ダッシュボード**
   - 発注状況の可視化（発注済/発注中/未発注）
   - リアルタイム粗利予測
   - アラート表示（原価超過、利益率低下）

### **DW側の役割**

1. **協力会社マスタ管理**
   - 協力会社の登録・更新
   - 過去実績・評価の管理

2. **発注実行・納期管理**
   - DRMから受け取った発注データで発注実行
   - 協力会社への通知
   - 納期管理

3. **現場での工事進捗管理**
   - 工事進捗の記録
   - 追加工事の管理（DW内で承認完結）
   - 諸口管理

4. **完了確認プロセス**
   - 工事完了確認
   - 確定原価の確定
   - DRMへ実績データ返送

---

## 📊 データフォーマット（CSVベース）

### **DRM → DW 送信データ**

```csv
プレイスコード,現場ID(*),現場名,現場管理担当者,発注ID,発注工事名(*),受注会社（ID入力）,区分(*),発注日,請負日,工事完了日,業種,ステータス（数値入力）(*),当初発注金額(税抜),消費税額,当初発注金額(税込),発注明細ID,発注明細項目名(*),数量(*),単位(*),単価(*),税率(*),合計金額(税抜),合計金額(税込),配送先,納品希望日,コメント,契約番号,営業所名,備考,工事確認日,完了日,適格事業者区分
```

**項目説明**:

- `プレイスコード`: テナントごとに設定されるDW側のコード（DRMでも保持）
- `現場ID`: 案件識別ID（例: 3229928）
- `発注工事名`: 工事項目名（例: 仮設工事、基礎工事）
- `受注会社（ID入力）`: 協力会社ID（ステータス3以降は必須）
- `区分`: 本体発注 / 追加発注
- `ステータス`:
  - 1: 見積（受注会社任意）
  - 2: 発注（受注会社任意だが、正式発注時は必須）
  - 4: 工事完了
  - 5: 工事確認
  - 6: 請求
- `当初発注金額(税抜)`: 発注金額
- `発注明細`: 項目名、数量、単位、単価、税率

**JSONフォーマット例**:

```json
{
  "placeCode": "ABC123",
  "projectId": "3229928",
  "projectName": "田中様邸新築工事",
  "projectManager": "山田太郎",
  "contractNumber": "CON-2024-001",
  "orders": [
    {
      "orderId": null, // DW側で採番
      "orderName": "仮設工事",
      "supplierId": "SUP-001", // A工業
      "category": "本体発注",
      "orderDate": "2024-10-10",
      "status": 2,
      "amountExcludingTax": 108500,
      "taxAmount": 10850,
      "amountIncludingTax": 119350,
      "details": [
        {
          "itemName": "仮設工事",
          "quantity": 1,
          "unit": "式",
          "unitPrice": 108500,
          "taxRate": 10
        }
      ]
    },
    {
      "orderId": null,
      "orderName": "基礎工事",
      "supplierId": "SUP-002", // B建設
      "category": "本体発注",
      "orderDate": "2024-10-10",
      "status": 2,
      "amountExcludingTax": 1601055,
      "taxAmount": 160105,
      "amountIncludingTax": 1761160,
      "details": [
        {
          "itemName": "基礎工事",
          "quantity": 1,
          "unit": "式",
          "unitPrice": 1601055,
          "taxRate": 10
        }
      ]
    }
  ]
}
```

### **DW → DRM 受信データ（日次取得）**

```json
{
  "projectId": "3229928",
  "syncDate": "2024-10-15",
  "orders": [
    {
      "orderId": "ORD-3229928-001",
      "orderName": "基礎工事",
      "supplierId": "SUP-002",
      "status": 4, // 工事完了
      "confirmedAmount": 1601055,
      "completionDate": "2024-10-15",
      "additionalWorks": [
        {
          "itemName": "追加土工事",
          "amount": 50000,
          "approved": true,
          "approvalDate": "2024-10-12"
        }
      ]
    },
    {
      "orderId": "ORD-3229928-002",
      "orderName": "仮設工事",
      "supplierId": "SUP-001",
      "status": 6, // 請求済
      "confirmedAmount": 108500,
      "completionDate": "2024-10-10",
      "invoiceDate": "2024-10-14",
      "additionalWorks": []
    }
  ]
}
```

---

## ⚙️ 発注先決定機能の詳細仕様

### **1. 発注先決定画面**

**パス**: `/contracts/[contractId]/order-allocation`

**UI構成**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【契約ID: CON-2024-001】田中様邸新築工事

契約金額: ¥35,000,000
予定原価: ¥28,000,000（粗利率: 20%）

⚠️ 発注期限: 2024-10-17まで（残り3日）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【発注項目一覧】全15項目

✅ 【仮設工事】¥108,500
   協力会社: A工業
   └ 過去実績: 5件 | 評価: ⭐4.5 | 空き状況: ◯

✅ 【基礎工事】¥1,601,055
   協力会社: B建設  [変更]
   └ 過去実績: 3件 | 評価: ⭐4.2 | 空き状況: ◯

📋 【造作工事】¥1,044,120
   協力会社: [▼ 選択してください]
   候補:
   - C工務店（過去実績: 8件、評価: 4.7、空き: ◯）
   - D建設（過去実績: 2件、評価: 4.0、空き: △）
   + 新規協力会社を登録

... 残り12項目 ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
発注状況: 2/15項目完了（13%）

[下書き保存] [承認申請（未完了項目あり）] ← 全項目完了で有効化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### **2. 協力会社選択モーダル**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
【造作工事】の協力会社を選択

🔍 [検索...]  [業種でフィルター: 造作 ▼]

┌─────────────────────────────────┐
│ ◯ C工務店（推奨）                    │
│   過去実績: 8件 | 平均評価: ⭐4.7    │
│   平均単価: ¥1,050,000 (今回: ¥1,044,120) │
│   空き状況: ◯ 対応可能               │
│   前回納期: 平均45日                 │
├─────────────────────────────────┤
│ ◯ D建設                              │
│   過去実績: 2件 | 平均評価: ⭐4.0    │
│   平均単価: ¥1,100,000 (今回: ¥1,044,120) │
│   空き状況: △ 要確認                │
│   前回納期: 平均50日                 │
├─────────────────────────────────┤
│ + 新規協力会社を登録                 │
└─────────────────────────────────┘

[キャンセル] [選択]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### **3. 発注期限アラート**

**アラート条件**:

- 契約締結日 + 設定日数（デフォルト7日）
- 残り2日でアラート（営業・施工管理のダッシュボードに表示）
- 期限超過で上司に通知 + 履歴記録

**通知内容**:

```
⚠️ 発注期限アラート

案件: 田中様邸新築工事（CON-2024-001）
期限: 2024-10-17（残り2日）
未割当: 13/15項目（87%）
担当: 山田太郎

→ 詳細を見る
```

**期限超過時の履歴**:

```json
{
  "contractId": "CON-2024-001",
  "deadline": "2024-10-17",
  "actualCompleteDate": "2024-10-20",
  "delayDays": 3,
  "assignedBy": "山田太郎",
  "notifiedTo": ["佐藤部長", "鈴木事業部長"],
  "reason": "協力会社の選定に時間を要した"
}
```

### **4. 発注承認フロー**

**金額別承認ルート**（会社ごとに設定可能）:

```
総発注金額が:
- 100万円未満    → 自動承認（または課長承認）
- 100-500万円   → 部長承認
- 500-1000万円  → 部長 + 事業部長承認
- 1000万円以上  → 役員承認
```

**承認画面**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
発注承認依頼

案件: 田中様邸新築工事
契約金額: ¥35,000,000
総発注金額: ¥13,500,000（予定原価の48%）

【発注内訳】15項目
- 仮設工事: A工業 ¥108,500
- 基礎工事: B建設 ¥1,601,055
...

粗利予測: 20.5%（計画: 20%、差: +0.5%）

[承認] [差戻し] [コメント]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📈 原価管理ダッシュボード

**パス**: `/construction/cost-management/[projectId]`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【現場ID: 3229928】田中様邸新築工事

📊 契約・原価サマリー
┌────────────────────────────────────────┐
│ 契約金額:     ¥35,000,000                  │
│ 予定原価:     ¥28,000,000（粗利率 20.0%） │
│ 確定原価:     ¥27,500,000（粗利率 21.4%） │
│ 差分:         -¥500,000 👍（+1.4%）       │
└────────────────────────────────────────┘

📦 発注状況（リアルタイム）
┌────────────────────────────────────────┐
│ ✅ 発注済み:  ¥15,000,000（54%）          │
│ ⏳ 発注中:    ¥8,000,000（29%）           │
│    └ DWでステータス1-2の合計              │
│ 📋 未発注:    ¥5,000,000（18%）           │
└────────────────────────────────────────┘

💰 実績原価（DWから毎日取得）
┌────────────────────────────────────────┐
│ ✅ 確定済み:  ¥10,000,000（36%）          │
│    └ ステータス6（請求済）                 │
│ 🔧 工事中:    ¥12,000,000（43%）          │
│    └ ステータス2-5                         │
│ 📋 未着工:    ¥5,500,000（20%）           │
└────────────────────────────────────────┘

🎯 粗利予測（リアルタイム計算）
┌────────────────────────────────────────┐
│ 予測粗利:     ¥7,500,000                  │
│ 予測粗利率:   21.4%                        │
│ 計画との差:   +1.4% 👍                     │
│                                            │
│ ⚠️ アラート: なし                          │
└────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 発注明細（15項目）

項目           | 予定原価    | 発注先  | ステータス | 確定原価    | 差額
──────────────┼────────────┼────────┼───────────┼────────────┼─────────
仮設工事       | ¥108,500   | A工業   | 請求済(6)  | ¥108,500   | ¥0
基礎工事       | ¥1,601,055 | B建設   | 工事完了(4)| ¥1,651,055 | +¥50,000 ⚠️
造作工事       | ¥1,044,120 | C工務店 | 発注中(2)  | -          | -
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔧 技術仕様

### **API連携方式**

**DRM → DW**: REST API (POST)

```
POST https://dw.example.com/api/orders/bulk-create
Headers:
  Authorization: Bearer {API_KEY}
  Content-Type: application/json

Body: {
  "placeCode": "ABC123",
  "projectId": "3229928",
  "orders": [...]
}

Response: {
  "success": true,
  "ordersCreated": [
    {
      "tempId": "DRM-3229928-001",
      "orderId": "ORD-3229928-001",
      "orderName": "仮設工事"
    },
    ...
  ]
}
```

**DW → DRM**: REST API (GET) - 毎日実行

```
GET https://drm.example.com/api/construction/sync-costs?projectId=3229928
Headers:
  Authorization: Bearer {API_KEY}

Response: {
  "projectId": "3229928",
  "syncDate": "2024-10-15",
  "orders": [...]
}
```

### **発注ID採番ルール**

**ハイブリッド方式**:

1. DRM側で一時ID生成: `DRM-{現場ID}-{連番}`
2. DWへ送信時に一時IDを含める
3. DW側で正式な発注ID採番: `ORD-{現場ID}-{連番}`
4. レスポンスで「一時ID → 正式ID」のマッピングを返す
5. DRM側で正式IDに更新

**メリット**:

- DW側の既存仕様変更不要
- DRM側でも送信前から管理可能
- データ整合性を保証

---

## ⚙️ 設定項目（管理コンソール）

### **1. 発注管理設定** (`/admin/order-settings`)

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚙️ 発注管理設定

【発注期限設定】
契約締結後の発注期限: [7] 日以内

【アラート設定】
期限前アラート: 契約締結後 [5] 日でアラート表示
期限超過時の通知先:
  ☑ 上司（組織階層の1つ上）
  ☑ 事業部長
  ☐ 代表取締役

【発注承認設定】
総発注金額による承認ルート:
  - 100万円未満:    [自動承認 ▼]
  - 100-500万円:   [部長承認 ▼]
  - 500-1000万円:  [部長+事業部長 ▼]
  - 1000万円以上:  [役員承認 ▼]

【DW連携設定】
DW API エンドポイント: [https://dw.example.com/api]
API認証キー: [********************]
プレイスコード: [ABC123]
同期頻度: [毎日 1:00 AM ▼]

[保存]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### **2. 原価管理設定** (`/admin/cost-settings`)

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚙️ 原価管理設定

【アラート閾値】
原価超過アラート: 予定原価の [10]% 超過でアラート
利益率低下アラート: 粗利率が [5]% 未満でアラート

【自動承認条件】
利益率が [15]% 以上の場合、自動承認

【差分管理】
差分表示単位: [円 ▼]（円/千円/百万円）
差分色分け:
  - プラス: [緑 ▼]
  - マイナス: [赤 ▼]
  - ±3%以内: [黄色 ▼]

[保存]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📅 実装計画（修正版）

### **Phase 1: 設定基盤構築** (2日)

1. `/admin/order-settings` - 発注管理設定画面
2. `/admin/cost-settings` - 原価管理設定画面
3. 設定用API作成
4. DW連携のAPI基盤構築

### **Phase 2: 発注先決定機能** (3-4日)

1. `/contracts/[id]/order-allocation` - 発注先決定画面
2. 協力会社選択UI（過去実績・評価表示）
3. 発注期限アラート機能
4. 発注承認フロー統合
5. DRM → DW API送信機能

### **Phase 3: DW連携実装** (2-3日)

1. DW → DRM API受信機能（日次バッチ）
2. 発注IDマッピング管理
3. ステータス同期
4. エラーハンドリング・リトライ処理

### **Phase 4: 原価管理ダッシュボード** (3日)

1. `/construction/cost-management/[id]` - 原価管理画面
2. リアルタイム粗利計算
3. 予定原価 vs 確定原価の差分表示
4. 発注状況の可視化
5. アラート表示

### **Phase 5: 工事台帳統合** (2-3日)

1. `/construction/ledger` の拡張
2. 確定原価の自動反映
3. 履歴管理
4. レポート機能強化

### **Phase 6: テスト・調整** (2-3日)

1. エンドツーエンドテスト
2. DW連携テスト
3. パフォーマンステスト
4. ユーザー受入テスト

**合計**: 約14-18日（3週間）

---

## 🎯 成功指標（KPI）

1. **発注期限遵守率**: 95%以上
2. **原価差分の早期検知**: 工事中に100%検知
3. **粗利予測の精度**: ±3%以内
4. **DW連携の成功率**: 99%以上
5. **発注承認時間**: 平均24時間以内

---

## ⚠️ 重要な注意事項

1. **DW連携の信頼性**
   - API失敗時のリトライ処理必須
   - データ不整合時のアラート
   - 手動同期の仕組みも用意

2. **協力会社マスタの同期**
   - DW側の協力会社マスタをDRMに定期同期
   - 新規協力会社登録時の逆同期

3. **ステータス管理の厳密化**
   - ステータス遷移のルール厳守
   - 不正な遷移の防止

4. **セキュリティ**
   - API認証キーの安全な管理
   - データ暗号化（特に金額情報）

5. **履歴の完全保存**
   - 発注先変更の履歴
   - 原価変更の履歴
   - 承認履歴

---

**最終更新**: 2025-10-08  
**次のアクション**: Phase 1の設定画面実装開始  
**参照ドキュメント**: CSVフォーマット（ダンドリ読込用\_3229928.csv）
