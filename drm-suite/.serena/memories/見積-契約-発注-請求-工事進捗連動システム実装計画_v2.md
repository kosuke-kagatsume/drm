# 見積→契約→発注→請求→工事進捗連動システム 実装計画 v2.0

**作成日**: 2025-10-08  
**更新日**: 2025-10-08 (発注管理機能を追加)  
**目的**: 見積から請求までの完全自動化（DRMとDWのAPI連携含む）

---

## 🎯 修正された全体フロー

```
【DRM】見積作成・承認
   ↓
【DRM】契約締結
   ↓
【DRM】発注先決定（7日以内）★新規追加★
   ↓
【API】DRM → DW (発注データ送信)
   ↓
【DW】発注実行・現場管理
   ↓
【API】DW → DRM (実績原価取得)
   ↓
【DRM】工事台帳に確定原価反映
   ↓
【DRM】粗利予測リアルタイム計算
   ↓
【DRM】請求書発行（マイルストーン/進捗率連動）
   ↓
【DRM】入金管理
```

---

## 📋 実装済み機能（再確認）

### ✅ 管理コンソール (`/admin`)

- ユーザー・権限・組織管理
- 承認フロー管理（見積/契約/請求書/経費/発注）
- マスタ管理（商品/作業項目/顧客/協力会社）
- メール設定

### ✅ 契約書管理 (`/contracts`)

- 契約一覧・詳細
- マイルストーン管理
- 変更指示管理
- 5種類のテンプレート

### ✅ 請求書管理 (`/invoices`)

- 請求書一覧・作成
- 分割請求管理
- 支払ステータス追跡

### ✅ 工事進捗監視 (`/construction/monitoring`)

- リアルタイム監視
- アラート機能
- KPIダッシュボード

### ✅ 見積システム (`/estimates`)

- editor-v3 Pro版
- ステータス管理
- テンプレート管理

---

## 🚀 実装計画（Phase 1-7）

### **Phase 1: 設定基盤構築** (2日)

**目標**: 全機能の設定画面を構築

**実装内容**:

1. `/admin/workflow-settings` - 業務フロー設定
   - 見積→契約変換設定
   - 項目マッピング設定

2. `/admin/order-settings` - **発注管理設定（新規）**
   - 発注期限設定（デフォルト7日）
   - アラート設定
   - 発注承認ルート（金額別）
   - DW連携設定（APIエンドポイント、認証キー、プレイスコード）

3. `/admin/billing-settings` - 請求設定
   - 請求タイミング設定
   - 分割請求パターン
   - 自動化ルール

4. `/admin/cost-settings` - **原価管理設定（新規）**
   - アラート閾値（原価超過、利益率低下）
   - 自動承認条件
   - 差分管理設定

5. 設定用API作成
   - `POST /api/admin/workflow-settings`
   - `POST /api/admin/order-settings`
   - `POST /api/admin/billing-settings`
   - `POST /api/admin/cost-settings`

**成果物**: 全設定画面が動作し、設定値がDBに保存される

---

### **Phase 2: 見積→契約変換** (2-3日)

**目標**: 見積承認後、ワンクリックで契約書作成

**実装内容**:

1. 見積詳細画面に「契約書作成」ボタン
2. 自動項目マッピング（見積項目 → 契約条項）
3. 契約書プレビュー機能
4. 承認フロー起動

**API**:

- `POST /api/estimates/[id]/convert-to-contract`

**成果物**: 見積から契約書が自動生成され、承認フローに入る

---

### **Phase 3: 契約→発注先決定** (3-4日) ★核心機能★

**目標**: 契約後7日以内に全原価の発注先を決定し、DWへ送信

**実装内容**:

1. `/contracts/[id]/order-allocation` - 発注先決定画面
   - 全原価項目の一覧表示
   - 協力会社選択UI（過去実績・評価表示）
   - 発注状況の進捗表示（2/15項目完了など）
   - 下書き保存機能

2. 協力会社選択モーダル
   - 過去実績・評価の表示
   - 平均単価との比較
   - 空き状況の表示
   - 新規協力会社登録リンク

3. 発注期限アラート
   - 契約締結後7日（設定可能）の期限管理
   - 残り2日でアラート表示
   - 期限超過時に上司へ通知
   - 履歴の完全記録

4. 発注承認フロー
   - 金額別承認ルート分岐
   - 承認画面の実装
   - 承認履歴の記録

5. DRM → DW API送信機能
   - CSV形式準拠のJSON送信
   - 発注IDのハイブリッド採番（一時ID → 正式ID）
   - エラーハンドリング・リトライ処理

**API**:

- `POST /api/contracts/[id]/allocate-orders`
- `POST /api/contracts/[id]/submit-orders` (DWへ送信)
- `GET /api/suppliers/search?category=xxx` (協力会社検索)

**DW連携API**:

- `POST https://dw.example.com/api/orders/bulk-create`

**成果物**: 契約から発注先決定、DWへの送信まで完結

---

### **Phase 4: DW連携・原価同期** (2-3日)

**目標**: DWから実績原価を取得し、工事台帳に反映

**実装内容**:

1. DW → DRM API受信機能（日次バッチ）
   - 毎日1:00 AMに自動実行
   - 全案件の実績原価を取得
   - ステータス同期（発注中/工事完了/請求済など）

2. 発注IDマッピング管理
   - 一時ID → 正式IDの変換テーブル
   - マッピングの自動更新

3. エラーハンドリング
   - API失敗時のリトライ（最大3回）
   - データ不整合時のアラート
   - 手動同期機能

4. 協力会社マスタ同期
   - DW側の協力会社マスタをDRMに定期同期
   - 新規協力会社登録時の逆同期

**API**:

- `GET /api/construction/sync-costs?projectId=xxx` (DWへのリクエスト)
- `POST /api/construction/update-costs` (取得データをDB保存)

**成果物**: DWとの完全なデータ同期が実現

---

### **Phase 5: 原価管理ダッシュボード** (3日)

**目標**: リアルタイム原価管理と粗利予測

**実装内容**:

1. `/construction/cost-management/[id]` - 原価管理画面
   - 契約・原価サマリー
   - 発注状況（発注済/発注中/未発注）
   - 実績原価（確定済/工事中/未着工）
   - 粗利予測（リアルタイム計算）

2. リアルタイム粗利計算
   - 予定原価 vs 確定原価の差分
   - 粗利率の自動計算
   - アラート表示（原価超過、利益率低下）

3. 発注明細テーブル
   - 15項目の詳細表示
   - ステータス別の色分け
   - 差額の強調表示

4. グラフ表示
   - 原価推移グラフ
   - 発注状況の円グラフ
   - 粗利予測の折れ線グラフ

**成果物**: 原価管理がリアルタイムで可視化される

---

### **Phase 6: 契約→請求発行** (2-3日)

**目標**: 契約・工事進捗に基づく自動請求書発行

**実装内容**:

1. 契約詳細画面に「請求書発行」ボタン

2. マイルストーン連動請求
   - マイルストーン完了時の自動請求トリガー
   - 工程別の請求額計算

3. 分割請求スケジュール自動生成
   - 設定された分割パターン（30%-40%-30%など）
   - カレンダー表示
   - 請求予定の自動リマインド

4. 出来高請求
   - 進捗率に基づく請求額計算
   - DWから取得した工事進捗を反映

5. 請求書自動送付
   - 承認完了後の自動メール送信
   - PDF自動添付

**API**:

- `POST /api/contracts/[id]/create-invoice`
- `POST /api/contracts/[id]/generate-billing-schedule`

**成果物**: 契約から請求書が自動発行され、顧客に送信される

---

### **Phase 7: 承認統合&テスト** (2-3日)

**目標**: 全フロー統合とエンドツーエンドテスト

**実装内容**:

1. 全フロー承認連携
   - 見積→契約→発注→請求の承認チェーン
   - 金額別承認ルート自動分岐

2. 通知システム統合
   - 各段階での承認者通知
   - 発注期限アラート
   - 原価超過アラート
   - 督促メール

3. エンドツーエンドテスト
   - 見積作成→承認→契約→発注先決定→DW送信→工事進捗→請求→入金の全フローテスト
   - DW連携テスト
   - パフォーマンステスト

4. 管理者向けダッシュボード強化
   - 全案件の進捗可視化
   - 承認待ち一覧
   - 収益予測ダッシュボード

**成果物**: 全機能が統合され、本番運用可能な状態

---

## 📐 実装方針

### **設定ファーストアプローチ**

- Phase 1で全設定画面を構築
- 設定値はDBに保存し、業務ロジックで参照
- 設定変更だけで挙動を調整可能

### **既存コードの活用**

- 承認フロー管理の仕組みを拡張
- マスタ管理のUI/UXパターンを踏襲
- 工事監視のアラート機能を活用

### **段階的な展開**

- 各Phaseごとに動作確認
- ロールバック可能な構成
- 設定オフで元の動作に戻る

### **DW連携の信頼性**

- API失敗時のリトライ処理
- データ不整合時のアラート
- 手動同期の仕組みも用意

---

## 📅 想定スケジュール

- **Phase 1**: 2日（設定基盤）
- **Phase 2**: 3日（見積→契約）
- **Phase 3**: 4日（契約→発注）★核心★
- **Phase 4**: 3日（DW連携）
- **Phase 5**: 3日（原価ダッシュボード）
- **Phase 6**: 3日（契約→請求）
- **Phase 7**: 3日（統合テスト）

**合計**: 約21日（3週間）

---

## 🎯 成功指標（KPI）

1. 見積承認から契約書作成まで5分以内
2. 契約から発注先決定まで7日以内（期限遵守率95%以上）
3. 原価差分の100%早期検知
4. 粗利予測の精度±3%以内
5. DW連携成功率99%以上
6. 請求書発行ミスゼロ

---

## 🗂️ データベース設計（追加テーブル）

### **orders（発注テーブル）**

```sql
CREATE TABLE orders (
  id VARCHAR(50) PRIMARY KEY,
  temp_id VARCHAR(50),  -- 一時ID（DRM-xxx-xxx）
  contract_id VARCHAR(50) NOT NULL,
  project_id VARCHAR(50) NOT NULL,
  order_name VARCHAR(200) NOT NULL,
  supplier_id VARCHAR(50),  -- 協力会社ID（ステータス3以降必須）
  category VARCHAR(50),  -- 本体発注/追加発注
  status INT NOT NULL,  -- 1:見積 2:発注 4:完了 5:確認 6:請求
  amount_excluding_tax DECIMAL(12,2),
  tax_amount DECIMAL(12,2),
  amount_including_tax DECIMAL(12,2),
  order_date DATE,
  completion_date DATE,
  confirmed_amount DECIMAL(12,2),  -- DWから取得
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  FOREIGN KEY (contract_id) REFERENCES contracts(id),
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);
```

### **order_details（発注明細テーブル）**

```sql
CREATE TABLE order_details (
  id VARCHAR(50) PRIMARY KEY,
  order_id VARCHAR(50) NOT NULL,
  item_name VARCHAR(200) NOT NULL,
  quantity DECIMAL(10,2) NOT NULL,
  unit VARCHAR(20) NOT NULL,
  unit_price DECIMAL(12,2) NOT NULL,
  tax_rate INT NOT NULL,
  amount_excluding_tax DECIMAL(12,2),
  amount_including_tax DECIMAL(12,2),
  FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

### **order_allocations（発注先決定履歴）**

```sql
CREATE TABLE order_allocations (
  id VARCHAR(50) PRIMARY KEY,
  contract_id VARCHAR(50) NOT NULL,
  allocated_by VARCHAR(50) NOT NULL,  -- 担当者ID
  allocated_at TIMESTAMP NOT NULL,
  deadline DATE NOT NULL,
  is_overdue BOOLEAN DEFAULT FALSE,
  delay_days INT,
  notified_to TEXT,  -- JSON配列
  approval_status VARCHAR(20),  -- pending/approved/rejected
  approved_by VARCHAR(50),
  approved_at TIMESTAMP,
  FOREIGN KEY (contract_id) REFERENCES contracts(id)
);
```

### **dw_sync_logs（DW連携ログ）**

```sql
CREATE TABLE dw_sync_logs (
  id VARCHAR(50) PRIMARY KEY,
  sync_type VARCHAR(20),  -- send/receive
  project_id VARCHAR(50),
  sync_date TIMESTAMP,
  status VARCHAR(20),  -- success/failed/retry
  request_data TEXT,  -- JSON
  response_data TEXT,  -- JSON
  error_message TEXT,
  retry_count INT DEFAULT 0
);
```

---

## 📚 参照ドキュメント

- **DRM-DW連携\_発注管理システム完全仕様** - 詳細仕様書
- **CSVフォーマット**: ダンドリ読込用\_3229928.csv

---

**最終更新**: 2025-10-08  
**次のアクション**: Phase 1の設定画面実装開始  
**重要度**: ★★★★★（最優先）
