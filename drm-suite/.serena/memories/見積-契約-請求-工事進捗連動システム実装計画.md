# 見積→契約→請求→工事進捗連動システム 実装計画

**作成日**: 2025-10-08  
**目的**: 見積から契約書への自動変換、契約後の請求書発行、工事進捗との連動、承認ワークフローの統合

---

## 📊 既存実装の確認結果

### ✅ 実装済み機能

#### 管理コンソール (`/admin`)

- ユーザー・権限・組織管理
- **承認フロー管理** - 見積/契約/請求書/経費/発注の承認ルート設定
- **マスタ管理** - 商品/作業項目/顧客/協力会社のマスタデータ
- **メール設定** - 詳細な送信設定（ドメイン認証、IPウォームアップ、配信制御）

#### 契約書管理 (`/contracts`)

- 契約一覧・詳細表示（リスク管理、利益率追跡）
- **マイルストーン管理** - 工程ごとの進捗・金額管理
- **変更指示管理** (Change Orders) - 追加工事の管理
- 5種類の契約テンプレート
  - 建設工事請負契約
  - 下請負契約
  - 保守メンテナンス契約
  - 建設機械リース契約
  - コンサルティング契約

#### 請求書管理 (`/invoices`)

- 請求書一覧・作成・送付
- **分割請求管理** (`/invoices/management`)
- 支払ステータス追跡（未払い/一部入金/完済/遅延）
- 請求書テンプレート機能

#### 工事進捗監視 (`/construction/monitoring`)

- **リアルタイム監視** - 30秒自動更新
- コスト超過・利益率低下の自動アラート
- KPI指標ダッシュボード
- 原価管理と実績追跡

#### 見積システム (`/estimates`)

- editor-v3 Pro版エディタ（階層マスタ検索、原価管理）
- ステータス管理（下書き→提出→交渉→受注/失注）
- テンプレート管理
- PDF生成・AI/RAG機能

---

## ⚙️ 必要な設定項目（新規実装）

### 1️⃣ 見積→契約変換設定 (`/admin/workflow-settings`)

**基本設定**

- 自動変換オン/オフ
- デフォルト契約テンプレート選択（建設/下請/保守等）
- 電子署名プロバイダー設定

**項目マッピング設定**

- 見積項目 → 契約条項の対応ルール
- 金額・工期の自動反映設定
- 原価情報の引き継ぎ方式

**承認フロー紐付け**

- 見積承認完了時の自動契約書作成
- 契約書承認ルートの自動割当

---

### 2️⃣ 請求発行設定 (`/admin/billing-settings`)

**請求タイミング設定**

- マイルストーンベース（工程完了時に自動請求）
- 期日ベース（月末/月初など定期請求）
- 出来高ベース（進捗率連動）

**分割請求ルール**

- 着手金/中間金/完成金の比率設定
  - パターン例: 30%-40%-30%
  - パターン例: 10%-30%-30%-30%（4分割）
- マイルストーン別請求額の自動計算

**自動化設定**

- 請求書自動送付（メール）
- 督促メール自動送信（期限超過時）
- 支払確認後の次回請求自動発行

---

### 3️⃣ 工事進捗連動設定 (`/admin/construction-settings`)

**進捗率と請求の連動**

- 進捗率達成時の自動請求トリガー
- 出来高請求の計算方式

**原価管理ルール**

- 原価超過時の請求制限（例: 予算の110%超過で請求停止）
- 利益率基準（例: 利益率5%未満で警告）

**アラート閾値設定**

- コスト超過アラート（例: 予算の10%以上超過）
- 利益率低下アラート（例: 5%未満）
- スケジュール遅延アラート

**自動承認条件**

- 利益率が基準以上なら自動承認（例: 15%以上）
- 予算内収まり案件の簡易承認

---

### 4️⃣ 承認ワークフロー拡張 (`/admin/approval-flows` 拡張)

**金額別承認ルート分岐**

```
- 100万円未満    → 課長承認のみ
- 100-500万円   → 部長承認
- 500-1000万円  → 部長+事業部長承認
- 1000万円以上  → 役員承認
```

**緊急対応設定**

- 緊急時の承認スキップ条件
- 事後承認の記録・通知

**承認者管理**

- 代理承認者の自動割当
- 不在時のエスカレーション
- 承認期限とタイムアウト処理

---

## 🚀 実装計画（Phase 1-5）

### **Phase 1: 設定基盤構築** (1-2日)

**目標**: 全機能の設定画面を先に構築

**実装内容**

1. `/admin/workflow-settings` - 業務フロー設定画面
   - 見積→契約変換設定
   - 項目マッピング設定UI
   - テンプレート選択

2. `/admin/billing-settings` - 請求設定画面
   - 請求タイミング設定
   - 分割請求パターン設定
   - 自動化ルール設定

3. `/admin/construction-settings` - 工事設定画面
   - 進捗連動ルール
   - 原価管理基準
   - アラート閾値設定

4. 設定用API作成
   - `POST /api/admin/workflow-settings`
   - `POST /api/admin/billing-settings`
   - `POST /api/admin/construction-settings`

**成果物**: 全設定画面が動作し、設定値がDBに保存される状態

---

### **Phase 2: 見積→契約変換** (2-3日)

**目標**: 見積承認完了後、ワンクリックで契約書作成

**実装内容**

1. 見積詳細画面に「契約書作成」ボタン追加
   - パス: `/estimates/[id]` 修正

2. 自動項目マッピング実装
   - 見積項目 → 契約条項への変換ロジック
   - 金額・工期・顧客情報の自動反映
   - マイルストーンの自動生成

3. 契約書プレビュー機能
   - 変換結果のプレビュー表示
   - 手動調整UI
   - PDF生成プレビュー

4. 承認フロー起動
   - 設定された承認ルートに自動投入
   - 承認者への通知送信

**API**

- `POST /api/estimates/[id]/convert-to-contract`

**成果物**: 見積から契約書が自動生成され、承認フローに入る

---

### **Phase 3: 契約→請求発行** (2-3日)

**目標**: 契約に基づく自動請求書発行

**実装内容**

1. 契約詳細画面に「請求書発行」ボタン追加
   - パス: `/contracts/[id]` 修正

2. マイルストーン連動請求
   - マイルストーン完了時の自動請求トリガー
   - 工程別の請求額計算
   - 未請求マイルストーンの一覧表示

3. 分割請求スケジュール自動生成
   - 設定された分割パターンに基づく請求計画作成
   - カレンダー表示での請求予定管理
   - 請求予定の自動リマインド

4. 請求書自動送付
   - 承認完了後の自動メール送信
   - PDF自動添付
   - 送付履歴の記録

**API**

- `POST /api/contracts/[id]/create-invoice`
- `POST /api/contracts/[id]/generate-billing-schedule`

**成果物**: 契約から請求書が自動発行され、顧客に送信される

---

### **Phase 4: 工事進捗連動** (2-3日)

**目標**: 工事進捗に応じた自動請求と原価管理

**実装内容**

1. 進捗率入力UI強化
   - `/construction/monitoring` 修正
   - 進捗率入力時のリアルタイム計算
   - 出来高の自動算出

2. 進捗→請求自動トリガー
   - 進捗率達成時の自動請求書作成
   - 出来高請求の金額計算
   - 請求可能額の表示

3. 原価超過時の警告・制限
   - 予算超過時のアラート表示
   - 原価率が基準超過時の請求制限
   - 承認者への通知

4. リアルタイム利益率表示
   - 実績原価の自動更新
   - 予測利益率の計算
   - ダッシュボードへの反映

**API**

- `POST /api/construction/update-progress`
- `GET /api/construction/billable-amount`

**成果物**: 工事進捗と請求が自動連動し、原価管理がリアルタイムで行われる

---

### **Phase 5: 承認統合&テスト** (2-3日)

**目標**: 全フロー統合とエンドツーエンドテスト

**実装内容**

1. 全フロー承認連携
   - 見積→契約→請求の承認チェーン
   - 金額別承認ルート自動分岐
   - 代理承認・エスカレーション実装

2. 通知システム統合
   - 各段階での承認者通知
   - 進捗アラート通知
   - 督促メール自動送信

3. エンドツーエンドテスト
   - 見積作成→承認→契約→工事開始→進捗更新→請求→入金の全フローテスト
   - 各種アラート・制限の動作確認
   - パフォーマンステスト

4. 管理者向けダッシュボード強化
   - 全案件の進捗可視化
   - 承認待ち一覧
   - 収益予測ダッシュボード

**成果物**: 全機能が統合され、本番運用可能な状態

---

## 📐 実装方針

### **設定ファーストアプローチ**

- 各機能の実装前に、必ず設定画面を先に作成
- 設定値はDBに保存し、業務ロジックで参照
- 設定変更だけで挙動を調整可能に（コード変更不要）

### **既存コードの活用**

- 承認フロー管理（`/admin/approval-flows`）の仕組みを拡張
- マスタ管理のUI/UXパターンを踏襲
- 工事監視のアラート機能を請求システムに連携
- メール設定の送信機能を再利用

### **段階的な展開**

- Phase 1で設定基盤構築 → 以降は設定を使った機能実装
- 各Phaseごとに動作確認・デモ
- 設定画面はコンポーネント化して再利用
- ロールバック可能な構成（設定オフで元の動作に戻る）

### **データ整合性の確保**

- トランザクション処理の徹底
- 承認履歴の完全記録
- 変更履歴のログ保存
- エラー時のロールバック機構

---

## 🗂️ 技術スタック

- **フロントエンド**: Next.js 14 + TypeScript + Tailwind CSS
- **バックエンド**: NestJS（既存のsvc-estimate, svc-contractなど）
- **データベース**: Prisma ORM
- **認証**: 既存のAuthContext
- **通知**: 既存のメール設定機能

---

## 📝 重要な注意事項

1. **承認フロー必須**
   - 見積→契約、契約→請求、工事進捗→請求のすべてに承認を組み込む
   - 金額や利益率に応じた承認ルート分岐

2. **設定の柔軟性**
   - 企業ごとに業務フローが異なるため、設定で調整可能に
   - デフォルト設定を用意し、カスタマイズ可能に

3. **既存機能との整合性**
   - 既存の見積/契約/請求書画面を壊さない
   - 段階的に機能追加（オプトイン方式）

4. **テストデータ**
   - 各Phaseで実際のデータフローをテスト
   - エッジケース（原価超過、承認タイムアウトなど）の確認

---

## 📅 想定スケジュール

- **Phase 1**: 2日（設定基盤）
- **Phase 2**: 3日（見積→契約）
- **Phase 3**: 3日（契約→請求）
- **Phase 4**: 3日（工事進捗連動）
- **Phase 5**: 3日（統合テスト）

**合計**: 約14日（2週間）

---

## 🎯 成功指標

1. 見積承認から契約書作成まで5分以内
2. 工事進捗入力から請求書発行まで自動化
3. 原価超過案件の100%早期検知
4. 承認待ち時間の50%削減
5. 請求書発行ミスゼロ

---

**最終更新**: 2025-10-08  
**次のアクション**: Phase 1の設定画面実装開始
