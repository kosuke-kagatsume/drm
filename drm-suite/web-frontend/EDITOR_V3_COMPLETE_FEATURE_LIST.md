# 見積エディタ V3 完全機能リスト

**作成日**: 2025/10/14
**目的**: V3の全機能を網羅的にリスト化し、V5への移植判断の材料とする

---

## 📊 V3の構成

| 要素                       | 数量     | 備考                     |
| -------------------------- | -------- | ------------------------ |
| **総行数**                 | 4,391行  | メインファイル           |
| **State変数**              | 43個     | useState使用             |
| **主要ハンドラー**         | 18個以上 | handleXXX関数            |
| **外部コンポーネント**     | 8個      | モーダル・ワークフロー等 |
| **外部コンポーネント行数** | 2,185行  | 5つの主要コンポーネント  |
| **マスタデータ**           | 75項目   | 12カテゴリ、63商品種別   |

---

## 🎯 機能分類（V5への移植判断付き）

### ✅ Tier 1: 基本機能（V4で実装済み）

| 機能                   | V3実装   | V4実装   | 判定           |
| ---------------------- | -------- | -------- | -------------- |
| テーブル表示           | ✅       | ✅       | **移植済み**   |
| 行追加・削除           | ✅       | ✅       | **移植済み**   |
| 行複製                 | ✅       | ✅       | **移植済み**   |
| セル編集               | ✅       | ✅       | **移植済み**   |
| カテゴリ選択（12種類） | ✅       | ✅       | **移植済み**   |
| 単位選択（11種類）     | ✅       | ✅       | **移植済み**   |
| 金額自動計算           | ✅       | ✅       | **移植済み**   |
| 合計金額表示           | ✅       | ✅       | **移植済み**   |
| ローカルストレージ保存 | ✅       | ✅       | **移植済み**   |
| 自動保存               | ✅ (3秒) | ✅ (5秒) | **移植済み**   |
| 未保存警告             | ✅       | ✅       | **移植済み**   |
| ローディング画面       | ✅       | ✅       | **移植済み**   |
| エラー表示             | ✅       | ✅       | **移植済み**   |
| 保存メッセージ         | ✅       | ✅       | **移植済み**   |
| CSVエクスポート        | ❌       | ✅       | **V4の新機能** |
| CSVインポート          | ❌       | ✅       | **V4の新機能** |
| コメント機能           | ✅       | ✅       | **移植済み**   |

---

### 🔴 Tier 2: 企業向け必須機能（V4未実装）

#### 2-1. バージョン管理システム 🚨

**コンポーネント**: `VersionManager.tsx` (423行)

| 機能                  | 詳細                             | 優先度   |
| --------------------- | -------------------------------- | -------- |
| バージョン番号管理    | メジャー/マイナー/ドラフト       | **必須** |
| バージョン一覧表示    | 全バージョンの履歴               | **必須** |
| バージョン切り替え    | ワンクリックで過去版に移動       | **必須** |
| バージョン比較        | 2つのバージョンの差分表示        | 高       |
| 新バージョン作成      | 変更メモ付きで作成               | **必須** |
| バージョンステータス  | draft/active/archived/superseded | **必須** |
| 変更履歴（changelog） | 各バージョンの変更内容           | 中       |
| アーカイブ機能        | 旧バージョンをアーカイブ         | 中       |
| 復元機能              | アーカイブから復元               | 低       |

**State変数（V3）**:

```typescript
const [showVersionManager, setShowVersionManager] = useState(false);
const [estimateVersions, setEstimateVersions] = useState<EstimateVersion[]>([]);
const [currentVersionId, setCurrentVersionId] = useState<string>('');
```

**V5での実装方針**:

- ✅ 必須: バージョン番号、一覧、切り替え、新規作成、ステータス
- ⚠️ 簡略化: 比較機能は基本的な差分表示のみ
- ❌ 削除: アーカイブ・復元は省略可能

**推定コード量**: 200-250行（V3の423行から48%削減）

---

#### 2-2. 承認ワークフローシステム 🚨

**コンポーネント**: `ApprovalWorkflow.tsx` (486行)

| 機能             | 詳細                   | 優先度   |
| ---------------- | ---------------------- | -------- |
| 承認申請         | 見積を承認申請         | **必須** |
| 承認ステップ管理 | 多段階承認             | **必須** |
| 承認者設定       | ステップごとの承認者   | **必須** |
| 承認アクション   | approve/reject         | **必須** |
| 委譲機能         | 承認を他者に委譲       | 低       |
| 承認履歴         | タイムライン表示       | 中       |
| 緊急度設定       | urgent/high/normal/low | 低       |
| 承認コメント     | 承認・却下時のコメント | 中       |
| 通知システム     | 承認者への通知         | 中       |
| 並列承認         | 複数人が同時承認       | 低       |
| 順次承認         | 順番に承認             | 中       |

**State変数（V3）**:

```typescript
const [showApprovalWorkflow, setShowApprovalWorkflow] = useState(false);
const [approvalWorkflow, setApprovalWorkflow] =
  useState<ApprovalWorkflowType | null>(null);
```

**V5での実装方針**:

- ✅ 必須: 承認申請、1-2段階承認、approve/reject、承認履歴
- ⚠️ 簡略化: 緊急度は3段階に削減（高/中/低）
- ❌ 削除: 委譲機能、並列承認は省略

**推定コード量**: 250-300行（V3の486行から40%削減）

---

#### 2-3. テンプレート選択システム 🔶

**コンポーネント**: `TemplateSelectModal.tsx` (652行)

| 機能                   | 詳細                       | 優先度   |
| ---------------------- | -------------------------- | -------- |
| テンプレート一覧       | カテゴリ別表示             | **必須** |
| テンプレート適用       | 選択したテンプレートを適用 | **必須** |
| セクション選択         | テンプレートの一部を選択   | 中       |
| スコープ管理           | personal/branch/company    | 中       |
| 支店別テンプレート     | 東京/大阪/名古屋           | 低       |
| 価格調整機能           | 0.1倍〜2.0倍の一括調整     | 中       |
| テンプレートプレビュー | 適用前のプレビュー         | 低       |
| 使用統計               | 使用回数・最終使用日       | 低       |
| タグ管理               | テンプレートのタグ付け     | 低       |
| 検索機能               | テンプレート検索           | 中       |

**State変数（V3）**:

```typescript
const [showTemplateModal, setShowTemplateModal] = useState(false);
const [templateMode, setTemplateMode] = useState<'load' | 'save'>('load');
const [templates, setTemplates] = useState<EstimateTemplate[]>([]);
const [selectedTemplateItems, setSelectedTemplateItems] = useState<Set<string>>(
  new Set(),
);
```

**V5での実装方針**:

- ✅ 必須: 一覧表示、適用、検索
- ⚠️ 簡略化: セクション選択は基本的なチェックボックスのみ
- ❌ 削除: 支店別、使用統計、タグ管理は省略

**推定コード量**: 300-350行（V3の652行から45%削減）

---

### 🟡 Tier 3: 高度な機能（V4未実装、要検討）

#### 3-1. マスタ検索システム

**コンポーネント**: `GlobalMasterAddModal.tsx` (98行)

| 機能           | 詳細                            | 優先度 |
| -------------- | ------------------------------- | ------ |
| 階層検索       | カテゴリ→商品種別→メーカー→製品 | 高     |
| マスタ一覧表示 | 75項目のマスタデータ            | 高     |
| マスタ選択     | クリックで行に適用              | 高     |
| 検索機能       | キーワード検索                  | 高     |
| フィルター     | カテゴリ・商品種別でフィルター  | 中     |

**State変数（V3）**:

```typescript
const [showGlobalMasterModal, setShowGlobalMasterModal] = useState(false);
const [showMasterSearch, setShowMasterSearch] = useState(false);
const [masterSearchTerm, setMasterSearchTerm] = useState('');
const [masterSearchRow, setMasterSearchRow] = useState<string | null>(null);
const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
const [searchStep, setSearchStep] = useState<
  'category' | 'productType' | 'maker' | 'product'
>('category');
const [selectedProductType, setSelectedProductType] = useState<string | null>(
  null,
);
const [selectedMaker, setSelectedMaker] = useState<string | null>(null);
```

**V5での実装方針**:

- ✅ 実装: シンプルなモーダル形式（V4スタイル）
- ⚠️ 簡略化: 階層検索は2段階（カテゴリ→製品）に削減
- ✅ 必須: マスタデータ連携は継続

**推定コード量**: 150-200行（V3の98行+検索ロジック）

---

#### 3-2. 保存済み見積管理

**コンポーネント**: `SavedEstimatesModal.tsx` (526行)

| 機能             | 詳細                   | 優先度 |
| ---------------- | ---------------------- | ------ |
| 保存済み見積一覧 | 過去の見積を表示       | 中     |
| 見積読み込み     | 過去の見積を読み込む   | 中     |
| 見積検索         | キーワード検索         | 低     |
| フィルター       | 顧客・日付でフィルター | 低     |

**State変数（V3）**:

```typescript
const [showSavedEstimatesModal, setShowSavedEstimatesModal] = useState(false);
```

**V5での実装方針**:

- ⚠️ 検討中: 見積一覧画面（/estimates）で代替可能
- ❌ 独立モーダルは不要かもしれない

**推定コード量**: 0行（既存画面で代替） または 100-150行（簡易版モーダル）

---

#### 3-3. 原価管理システム

| 機能               | 詳細                 | 優先度 |
| ------------------ | -------------------- | ------ |
| 原価入力           | 各行に原価を入力     | 高     |
| 粗利計算           | (売価-原価)/売価×100 | 高     |
| 粗利率表示         | パーセント表示       | 高     |
| 原価掛率調整       | マスタ原価に掛率適用 | 中     |
| 原価タイプ         | master/negotiated    | 中     |
| 合計原価・合計粗利 | 全体の原価・粗利集計 | 高     |

**State変数（V3）**:

```typescript
const [showCostRateModal, setShowCostRateModal] = useState(false);
const [costRateModalRow, setCostRateModalRow] = useState<string | null>(null);
const [tempCostRate, setTempCostRate] = useState<number>(1.0);
```

**V5での実装方針**:

- ✅ 必須: 原価入力、粗利計算・表示、合計集計
- ⚠️ 簡略化: 掛率調整は簡易入力のみ（モーダル不要）
- ✅ V4には未実装だが、V5には必須

**推定コード量**: 100-150行（計算ロジック + UI）

---

#### 3-4. ドラッグ&ドロップ並び替え

**使用ライブラリ**: `@dnd-kit/core`, `@dnd-kit/sortable`

| 機能                  | 詳細             | 優先度 |
| --------------------- | ---------------- | ------ |
| 行のドラッグ&ドロップ | マウスで行を移動 | 中     |
| キーボード対応        | キーボードで移動 | 低     |
| アニメーション        | スムーズな移動   | 低     |

**V3の実装**:

```typescript
import { DndContext, DragEndEvent } from '@dnd-kit/core';
import { arrayMove, SortableContext } from '@dnd-kit/sortable';

const handleDragEnd = (event: DragEndEvent) => {
  // 複雑なドラッグ処理（約80行）
};
```

**V5での実装方針**:

- ❌ dnd-kitは使用しない（依存ライブラリ削減）
- ✅ V4の上下ボタンを継続使用
- **理由**: シンプルさ優先、V4で十分実用的

**推定コード量**: 0行（V4の実装を継続）

---

#### 3-5. PDF出力機能

| 機能             | V3実装          | V4実装       | 優先度 |
| ---------------- | --------------- | ------------ | ------ |
| PDF出力          | PDFエンジン     | ブラウザ印刷 | 高     |
| テンプレート選択 | ✅ 複数選択     | ❌           | 中     |
| ブランディング   | ✅ カスタマイズ | ❌           | 低     |
| 印刷最適化       | ❌              | ✅ CSS       | 高     |

**V3の実装**:

```typescript
const [showPdfTemplateSelector, setShowPdfTemplateSelector] = useState(false);
const [selectedPdfTemplate, setSelectedPdfTemplate] = useState<PdfTemplate | null>(null);

const handlePdfTemplateSelect = async (template: PdfTemplate) => {
  const response = await PdfTemplateEngine.generateFromTemplate({ ... });
};
```

**V5での実装方針**:

- ✅ V4のブラウザ印刷を継続（印刷最適化CSS付き）
- ⚠️ 検討: テンプレート選択機能を追加するか？
- **判断保留**: ユーザーのニーズ次第

**推定コード量**: 0行（V4継続） または 150-200行（テンプレート追加）

---

### 🟢 Tier 4: 便利機能（低優先度）

#### 4-1. Undo/Redo機能

| 機能             | 詳細           | 優先度 |
| ---------------- | -------------- | ------ |
| Undo（元に戻す） | Ctrl+Z         | 低     |
| Redo（やり直し） | Ctrl+Shift+Z   | 低     |
| 履歴管理         | 変更履歴を保持 | 低     |

**State変数（V3）**:

```typescript
const [history, setHistory] = useState<EstimateItem[][]>([]);
const [historyIndex, setHistoryIndex] = useState(-1);
```

**V5での実装方針**:

- ❌ 省略（実装コストに見合わない）
- 理由: 自動保存があれば十分

**推定コード量**: 0行（省略）

---

#### 4-2. 行・セルの選択機能

| 機能               | 詳細           | 優先度 |
| ------------------ | -------------- | ------ |
| 複数行選択         | Shift+クリック | 低     |
| 複数セル選択       | Ctrl+クリック  | 低     |
| 選択項目の一括操作 | コピー・削除   | 低     |

**State変数（V3）**:

```typescript
const [selectedRows, setSelectedRows] = useState<Set<string>>(new Set());
const [selectedCells, setSelectedCells] = useState<Set<string>>(new Set());
```

**V5での実装方針**:

- ❌ 省略（複雑さ増加）
- 理由: 単一行操作で十分

**推定コード量**: 0行（省略）

---

#### 4-3. 表示モード切り替え

| 機能       | 詳細         | 優先度 |
| ---------- | ------------ | ------ |
| 顧客用表示 | 原価を非表示 | 低     |
| 社内用表示 | 原価を表示   | 低     |

**State変数（V3）**:

```typescript
const [viewMode, setViewMode] = useState<'customer' | 'internal'>('internal');
```

**V5での実装方針**:

- ❌ 省略（PDF出力時に調整可能）
- 理由: 機能として必須ではない

**推定コード量**: 0行（省略）

---

#### 4-4. その他の細かい機能

| 機能                     | 詳細                       | 優先度 | 判定              |
| ------------------------ | -------------------------- | ------ | ----------------- |
| 有効期限編集             | 見積の有効期限設定         | 低     | ✅ 実装（簡易）   |
| トースト通知             | 保存メッセージ表示         | 低     | ✅ 実装済み（V4） |
| キーボードショートカット | Ctrl+S等                   | 低     | ⚠️ 検討           |
| インポート機能           | CSV/Excelインポート        | 中     | ✅ 実装済み（V4） |
| テンプレート保存         | 現在の見積をテンプレート化 | 中     | ⚠️ 検討           |

---

## 📊 V5の推定コード量

### コンポーネント別内訳

| カテゴリ             | 機能                   | V3行数  | V5推定行数 | 削減率 |
| -------------------- | ---------------------- | ------- | ---------- | ------ |
| **基本機能**         | テーブル・編集・保存等 | 1,500行 | 1,700行    | ▲13%   |
| **バージョン管理**   | VersionManager         | 423行   | 200行      | ▼53%   |
| **承認ワークフロー** | ApprovalWorkflow       | 486行   | 250行      | ▼49%   |
| **テンプレート選択** | TemplateSelectModal    | 652行   | 300行      | ▼54%   |
| **マスタ検索**       | GlobalMasterAddModal   | 98行    | 150行      | △53%   |
| **原価管理**         | 原価計算・粗利表示     | 200行   | 150行      | ▼25%   |
| **保存済み見積**     | SavedEstimatesModal    | 526行   | 0行        | ▼100%  |
| **その他**           | PDF・有効期限等        | 506行   | 200行      | ▼60%   |
| **削除機能**         | Undo/Redo、選択等      | 300行   | 0行        | ▼100%  |

### 合計

```
V3総行数: 4,391行（メイン） + 2,185行（外部） = 6,576行
V5推定行数: 2,950行
削減率: 55.2% (▼3,626行削減)
```

**より保守的な見積もり**:

- バッファ込み: **3,000-3,200行**
- V3比: **52-54%削減**

---

## 🎯 V5の機能決定チェックリスト

### 必須実装（Tier 1 + Tier 2の一部）

- [x] ✅ 基本機能（V4で実装済み）
- [ ] 🔴 **バージョン管理** - 簡略版（200-250行）
- [ ] 🔴 **承認ワークフロー** - 1-2段階版（250-300行）
- [ ] 🔶 **テンプレート選択** - 基本版（300-350行）
- [ ] 🟡 **マスタ検索** - シンプル版（150-200行）
- [ ] 🟡 **原価管理** - 基本版（100-150行）

### 要検討（Tier 3）

- [ ] ⚠️ **PDF出力** - V4継続 or テンプレート追加？
- [ ] ⚠️ **保存済み見積** - 独立モーダル or 一覧画面で代替？
- [ ] ⚠️ **テンプレート保存** - 実装する？

### 不要（Tier 4）

- [ ] ❌ Undo/Redo - 省略
- [ ] ❌ 複数行・セル選択 - 省略
- [ ] ❌ ドラッグ&ドロップ - V4の上下ボタン継続
- [ ] ❌ 表示モード切り替え - 省略

---

## 💬 ユーザーへの質問リスト

V5の仕様を確定するために、以下の質問にご回答ください：

### 🔴 必須機能の仕様

#### Q1. バージョン管理

1. **バージョン比較機能は必要ですか？**
   - A) はい、2つのバージョンの差分表示が必須
   - B) 不要、バージョン切り替えだけでOK
   - C) 簡易版（変更箇所のハイライトのみ）

2. **アーカイブ・復元機能は必要ですか？**
   - A) はい、旧バージョンのアーカイブ・復元が必要
   - B) 不要、全バージョンを常に表示でOK

#### Q2. 承認ワークフロー

3. **承認段階はいくつ必要ですか？**
   - A) 1段階（上司の承認のみ）
   - B) 2段階（上司→経営者）
   - C) 3段階以上（多段階）

4. **委譲機能は必要ですか？**
   - A) はい、承認者が不在時に他者へ委譲が必須
   - B) 不要、承認者が戻るまで待つ

5. **緊急度設定は必要ですか？**
   - A) はい、4段階（urgent/high/normal/low）
   - B) 簡易版、3段階（高/中/低）
   - C) 不要

#### Q3. テンプレート選択

6. **セクション選択機能は必要ですか？**
   - A) はい、テンプレートの一部（セクション単位）を選択できる
   - B) 不要、テンプレート全体を適用するだけでOK

7. **支店別テンプレートは必要ですか？**
   - A) はい、東京/大阪/名古屋などの支店別テンプレート管理が必須
   - B) 不要、全社共通のテンプレートのみでOK

8. **価格一括調整機能は必要ですか？**
   - A) はい、テンプレート適用時に0.8倍などの一括調整が必要
   - B) 不要、適用後に個別編集すればOK

### 🟡 検討事項

#### Q4. マスタ検索

9. **階層検索は何段階必要ですか？**
   - A) 4段階（カテゴリ→商品種別→メーカー→製品）※V3と同じ
   - B) 2段階（カテゴリ→製品）※シンプル版
   - C) 1段階（全製品から検索）※最もシンプル

#### Q5. 原価管理

10. **原価掛率調整モーダルは必要ですか？**
    - A) はい、専用モーダルで細かく調整したい
    - B) 不要、直接セルに入力すればOK

#### Q6. PDF出力

11. **PDFテンプレート選択機能は必要ですか？**
    - A) はい、複数のPDFテンプレートから選択したい
    - B) 不要、V4のブラウザ印刷で十分

#### Q7. 保存済み見積

12. **保存済み見積モーダルは必要ですか？**
    - A) はい、エディタ内から過去の見積を素早く読み込みたい
    - B) 不要、見積一覧画面（/estimates）から開けば十分

#### Q8. その他

13. **テンプレート保存機能は必要ですか？**
    - A) はい、現在の見積をテンプレートとして保存したい
    - B) 不要、テンプレートは管理画面で作成すればOK

14. **キーボードショートカットは必要ですか？**
    - A) はい、Ctrl+S（保存）など実装してほしい
    - B) 不要、マウス操作で十分

---

## 📋 次のステップ

1. ✅ **V3の全機能リスト作成** ← 完了！
2. ⏭️ **ユーザーへの質問（14問）**
3. ⏭️ **回答を基にV5の仕様確定**
4. ⏭️ **V5の設計書作成**
5. ⏭️ **V5の実装開始**

---

**最終更新**: 2025/10/14
**作成者**: Claude Code
**ステータス**: V3全機能リスト完成、ユーザー質問準備完了
